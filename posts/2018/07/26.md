---
title: CentOS7ã«nginx&puma&Postgresql&Let's Encrypt&Rails5.2ç’°å¢ƒã‚’itamaeã§ä½œæˆã™ã‚‹
date: '2018-07-26'
archives: ["2018/07"]
categories:
  - é–‹ç™º
tags:
  - linux
  - itamae
  - centos
  - nginx
  - puma
  - rails
image: /images/20190513-155518.png
---
å…ˆæ—¥å…¬é–‹ã—ãŸ[ecdo](https://ecdoapp.com/)ã€ã¨ã‚Šã‚ãˆãšherokuã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãŸã®ã§ã™ãŒã€è«¸äº‹æƒ…ã«ã‚ˆã‚Šå›½å†…VPSã«å¼•ã£è¶Šã—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸğŸšš

<!--more-->

ã¾ã‚å¼•ã£è¶Šã—ã¨ã„ã£ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å—ã‘ä»˜ã‘ã¦ãªã‹ã£ãŸã—ã€dbã®å¼•ã£è¶Šã—ãŒç„¡ã„ã®ã§å˜ç´”ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚’å¤‰ãˆã¦DNSå¤‰ãˆã‚‹ã ã‘ã§ã‚«ãƒ³ã‚¿ãƒ³ã‚«ãƒ³ã‚¿ãƒ³ğŸ™†â€¦â€¦ã ã£ãŸã¯ãšãªã®ã«ã€CentOS7ã¨Let's Encryptã¨ã„ã†æ–°ã—ã„è¦ç´ ã‚‚ã‚ã£ã¦ãªã‹ãªã‹å¤§å¤‰ã§ã—ãŸã€‚ã®ã§ã€ãã®ä½œæ¥­ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

## CentOS 7

ã¾ãšå›½å†…ã®VPSã§è‰¯ã„ã®ãŒç„¡ã„ã‹ãªï¼Ÿã¨æ¢ã—ã¦ã¿ã¾ã—ãŸã€‚ç¬¬1å€™è£œã¯ã‚„ã£ã±ã‚Šã•ãã‚‰ã®VPSã ã£ãŸã®ã§ã™ãŒã€ã•ãã‚‰ã®VPSã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½ãŒ2018å¹´7æœˆ26æ—¥æ™‚ç‚¹ã§ç„¡ã„(ãã‚Œã«åˆæœŸè²»ç”¨ã¨ã‹ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—è²»ç”¨ãŒé«˜ã„ã‚ˆâ€¦â€¦)ã®ã§å´ä¸‹ã€‚ä»–ã«ã©ã“ã‹ãªã„ã‹ãªãƒ¼ã¨æ€ã£ã¦æ¢ã—ãŸã‚‰ConoHaã®VPSãŒè‰¯ã•ãã†ã ã£ãŸã®ã§ConoHaã«ã—ã¾ã—ãŸã€‚

![](/images/2018-07-26_11-10-12.png)

ConoHaã®VPSã¯ã‚µãƒ¼ãƒãƒ¼è¿½åŠ æ™‚ã«Railsæ§‹æˆãªã©ä½œã‚Œã‚‹ã¿ãŸã„ã§ã™ãŒã€ãã‚Œã ã¨å‹‰å¼·ã«ãªã‚‰ãªã„ã—ã€ãã‚‚ãã‚‚ä½•ãŒå…¥ã£ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ã®ã§ã€çœŸã£æ›´ãªçŠ¶æ…‹ã§å§‹ã‚ã¾ã™ã€‚

å»ºã¦ãŸã‚‰ç°¡å˜ã«rootã§sshã—ã¦ã¿ã¦ç¹‹ã’ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¦ãŠãã¾ã—ãŸã€‚ã“ã“ã‹ã‚‰itamaeã§ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã—ã¦ã„ãã¾ã™ã€‚

## nginx

CentOS7ç’°å¢ƒã§æ™®é€šã«`yum install -y nginx`ã™ã‚‹ã¨1.12ãŒå…¥ã‚‹ã®ã§ã™ãŒã€ã“ã‚ŒãŒå‹•ãã¾ã›ã‚“ğŸ˜­ å…·ä½“çš„ã«ã¯

```sh
nginx: [emerg] module â€œ/usr/lib64/nginx/modules/ngx_http_geoip_module.soâ€ version 1010002 instead of 1011009 in /usr/share/nginx/modules/mod-http-geoip.conf:1
```

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

å°‘ã—èª¿ã¹ã‚‹ã¨1.10ã‚’ä½¿ãˆã¨æ›¸ã„ã¦ã‚ã‚‹ã®ã§ã™ãŒã€`yum list --showduplicates nginx`ã—ã¦ã¿ã¦1.12ã—ã‹ç„¡ã„â€¦â€¦ã€‚[éå»ã®rpm](https://nginx.org/packages/rhel/6/x86_64/RPMS/)ã‚’æ¢ã—ã¦`yum install`ã—ã¦ã¿ã¦ã‚‚ä¾å­˜é–¢ä¿‚ãŒè§£æ±ºã—ãªã„ã€‚

ãˆãƒ¼â€¦â€¦å‚ã£ãŸãªã€‚ã¨æ€ã£ã¦ãµã¨nginxã®æœ€æ–°ç‰ˆã£ã¦ã„ãã¤ã ï¼Ÿã¨æ€ã£ã¦[èª¿ã¹ã¦ã¿ã‚‹](https://nginx.org/en/download.html)ã¨ã€1.15ãŒæœ€æ–°ç‰ˆã®ã‚ˆã†ã™ã€‚

`sudo vim /etc/yum.repos.d/nginx.repo`ã«

```conf
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/mainline/centos/7/$basearch/
gpgcheck=0
enabled=1
```

ã‚’æ›¸ãè¾¼ã‚“ã§ã€`yum remove -y nginx`ã‹ã‚‰ã®`yum install -y nginx`ã—ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã¨â€¦â€¦å‹•ã„ãŸâ—ğŸ˜­

ã‚ã¨ã¯ä¸å¿…è¦ãªdefaultã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‹railsã®å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æƒãˆãŸã‚Šãªã©ã®ä½œæ¥­ã‚’ã™ã‚Œã°ã€ã¨ã‚Šã‚ãˆãšğŸ†—ğŸ‘Œãªã¯ãšã€‚

ãƒ¬ã‚·ãƒ”ã¯ã“ã‚“ãªå…·åˆã«ãªã£ã¦ã¾ã™ã€‚

```ruby
# webã‚µãƒ¼ãƒãƒ¼ç³»ã®ãƒãƒ¼ãƒˆã‚’é–‹ã‘ã‚‹
execute "Open web server ports" do
  user "root"
  cmd = [
    'firewall-cmd --add-port=80/tcp --permanent',
    'firewall-cmd --add-port=443/tcp --permanent'
  ]
  command cmd.join('&&')
end

execute 'firewall-cmd --reload'

service 'firewalld' do
  action [:restart]
end

# CentOS7ã§æ™®é€šã«yumã§nginxã‚’å…¥ã‚Œã‚‹ã¨1.12ãŒå…¥ã‚‹ãŒã€
# ã“ã‚ŒãŒå‹•ã‹ãªã„ã®ã§ã€æœ€æ–°ç‰ˆã‚’å…¥ã‚Œã‚‹å¿…è¦æœ‰ã‚Š
template "/etc/yum.repos.d/nginx.repo"

package 'nginx'

%w(default.conf ssl.conf virtual.conf).each do |conf|
  file "Delete #{conf}" do
    path "/etc/nginx/conf.d/#{conf}"
    action :delete
  end
end

# railsã®å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨åˆã‚ã›ãªã„ã¨ã„ã‘ãªã„ã®ã§å¤‰æ›´ã™ã‚‹
file "Edit nginx.conf" do
  path "/etc/nginx/nginx.conf"
  action :edit
  block do |content|
    content.gsub!(/^.?user .+$/, "user root;")
  end
end

service 'nginx' do
  action [:enable, :start]
end
```

## Let's Encrypt

ã•ã¦Let's Encryptã§ã™ãŒã€itamaeã§ä½¿ãˆãã†ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹ã‘ã©â€¦â€¦è‡ªåˆ†ã®ç’°å¢ƒã§å‹•ã‹ãªã„ã€‚ã®ã§ã€2ã¤ã ã‘ãªã®ã§ã‚‚ã†ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã„ãã¾ã—ãŸã€‚

Let's Encryptã®æ³¨æ„ç‚¹ã¨ã—ã¦ã¯**ç”³è«‹ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«httpã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹**å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãªã®ã§å…ˆã«nginxã‚’èµ·å‹•ã•ã›ã€ç”³è«‹ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦nginxã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»é¢è¡¨ç¤ºã§ãã‚‹çŠ¶æ…‹ã§ãªã„ã¨ãƒ€ãƒ¡ã¿ãŸã„ã§ã™ã€‚

```ruby
package "git"
git "#{node.letsencrypt.cert_bot_path}" do
  repository "https://github.com/certbot/certbot"
end

execute "#{node.letsencrypt.cert_bot_path}/certbot-auto -n certonly --webroot -w #{node.letsencrypt.webroot} -d #{node.letsencrypt.domain} -m #{node.letsencrypt.mail_address} --agree-tos --server https://acme-v02.api.letsencrypt.org/directory"

execute %(echo "00 05 01 * * root #{node.letsencrypt.cert_bot_path}/certbot-auto renew --webroot -w #{node.letsencrypt.webroot} --post-hook 'systemctl reload nginx'" > /etc/cron.d/certbot-auto)

service 'nginx' do
  action [:restart]
end
```

###### node.yml
```yaml
letsencrypt:
  domain: YOUR_DOMAIN
  mail_address: YOUR_MAIL_ADDRESS
  cert_bot_path: /usr/local/certbot
  webroot: /usr/share/nginx/html
```

## Railså‘ã‘ã®nginxè¨­å®š

ç„¡äº‹Let's Encryptã§è¨¼æ˜æ›¸ãŒå–å¾—ã§ããŸã‚‰ã€Railsç”¨ã®nginxã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€é©ç”¨ã—ã¾ã™ã€‚ãƒ¬ã‚·ãƒ”ã¨confã¯ã“ã‚“ãªå…·åˆã«ãªã‚Šã¾ã—ãŸã€‚

```ruby
directory YOUR_APP_PATH do
  owner node[:user][:name]
  group node[:user][:name]
end

template "/etc/nginx/conf.d/app.conf" do
  source "./templates/app.conf.erb"
  variables app_path: YOUR_APP_PATH
  not_if "test -e /etc/nginx/conf.d/app.conf"
end

execute "openssl dhparam 2048 -out /etc/nginx/ssl/dhparam.pem"

execute 'npm install -g yarn'

file "/home/#{node['user']['name']}/.bashrc" do
  action :edit
  not_if "test $RAILS_MASTER_KEY"
  block do |content|
    content << %(export RAILS_MASTER_KEY="#{ENV["RAILS_MASTER_KEY"]}"\n)
  end
end
```

nodeã®æ‰€ã¯å„è‡ªã§ç½®ãæ›ãˆã¦ãã ã•ã„ã¾ã›orz

###### app.conf.erb

```conf
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

upstream <%= node.app.name %> {
  server unix://<%= @app_path %>/shared/tmp/sockets/puma.sock;
}

server {
  listen      80;
  listen [::]:80;
  return 301 https://$host$request_uri;
}

server{
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name <%= node.app.domain %>;
  root <%= @app_path %>/current/public;

  gzip on;
  gzip_types text/css application/javascript application/json application/font-woff application/font-tff image/gif image/png image/jpeg;
  gzip_min_length 1000;
  gzip_vary on;
  gzip_proxied any;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  ssl_certificate /etc/letsencrypt/live/<%= node.app.domain %>/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/<%= node.app.domain %>/privkey.pem;
  ssl_prefer_server_ciphers on;
  ssl_ciphers ECDHE+RSAGCM:ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:!aNULL!eNull:!EXPORT:!DES:!3DES:!MD5:!DSS;
  ssl_dhparam /etc/nginx/ssl/dhparam.pem;
  add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains;';
  client_max_body_size 64M;

  ssl_stapling on;
  ssl_stapling_verify on;
  ssl_trusted_certificate /etc/letsencrypt/live/<%= node.app.domain %>/fullchain.pem;

  resolver 8.8.8.8;

  location / {
    gzip_static on;
    proxy_pass http://<%= node.app.name %>;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location ~* ^/assets|iamges|favicon|packs/ {
    gzip_static on;
    # Per RFC2616 - 1 year maximum expiry
    expires 1y;
    add_header Cache-Control public;

    # Some browsers still send conditional-GET requests if there's a
    # Last-Modified header or an ETag header even if they haven't
    # reached the expiry date sent in the Expires header.
    add_header Last-Modified "";
    add_header ETag "";
    break;
  }
}
```

### ã„ãã¤ã‹æ³¨æ„ç‚¹

#### ssl_dhparam /etc/nginx/ssl/dhparam.pem;

`ssl_dhparam /etc/nginx/ssl/dhparam.pem;`ã¨ã„ã†è¨˜è¿°ã‚’ã—ãŸã®ã§ã€opensslã§ç”Ÿæˆã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```sh
execute "openssl dhparam 2048 -out /etc/nginx/ssl/dhparam.pem"
```

#### RAILS_MASTER_KEYã‚’ç™»éŒ²

ä»Šå›ã¯Rails5.2ãªã®ã§ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç³»ã¯åŸºæœ¬çš„ã«å…¨ã¦credentials.yml.encã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ãªã®ã§ã€ç’°å¢ƒå¤‰æ•°RAILS_MASTER_KEYã‚’è¨­å®šã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã™ãŒã€ä»¥ä¸‹ã¿ãŸã„ãªæ›¸ãæ–¹ãŒä¸€ç•ªå®‰å…¨ã‹ã¤åˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

```ruby
file "/home/#{node['user']['name']}/.bashrc" do
  action :edit
  not_if "test $RAILS_MASTER_KEY"
  block do |content|
    content << %(export RAILS_MASTER_KEY="#{ENV["RAILS_MASTER_KEY"]}"\n)
  end
end
```

#### VueJS(ã¨ã„ã†ã‹webpack)ç”¨ã«locationã«packsã‚’è¿½åŠ 

ä»Šå›ã¯Vue.js(Webpack)ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ã€public/ã«packsãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚ãªã®ã§ã€locationã«packsã‚’è¿½åŠ ã—ã¦ã‚ã’ã¾ã—ãŸã€‚

## SSLãƒ†ã‚¹ãƒˆã®çµæœã¯A+!! æ¬¡ã¯capistranoã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›¸ãã¾ã™

ã¨ã‚Šã‚ãˆãšã‚µãƒ¼ãƒãƒ¼ã‚’ä½œã‚‹æ™‚ã€è¾›ã‹ã£ãŸéƒ¨åˆ†ã¯æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚ã„ã¡ãŠã†SSL Server Testã§ã¯A+ã®çµæœãŒã§ãŸã®ã§ã€å¤šåˆ†å¤§ä¸ˆå¤«ã‹ãªã¨ã€‚

![](/images/2018-07-26_12-47-02.png)
[SSL Server Test: ecdoapp.com (Powered by Qualys SSL Labs)](https://www.ssllabs.com/ssltest/analyze.html?d=ecdoapp.com)

æ¬¡ã¯capistranoã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ™‚ã®è¨˜äº‹ã‚’æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚
