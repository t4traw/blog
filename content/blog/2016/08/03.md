---
title: Itamaeè‡ªåˆ†ãƒ¡ãƒ¢[2]ã€€Ruby(rbenv+ruby-build)ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
date: 2016-08-03
categories:
  - linux
tags:
  - itamae
  - centos
  - nginx
  - puma
  - ruby
image:
---
Rubyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã„ã¾ã™ã€‚Itamaeã®ãƒ¬ã‚·ãƒ”ã‚’ä½œã£ã¦ã„ã‚‹æ™‚ã«è‰²ã€…ãªã‚µã‚¤ãƒˆã§å‹‰å¼·ã—ã¦ã„ãŸã®ã§ã™ãŒã€ãªã‹ãªã‹ã‚µã‚¯ã£ã¨ã†ã¾ã„äº‹ã„ã‹ãªãã¦ã‹ãªã‚Šæ‚©ã¿ã¾ã—ãŸã€‚

<!--more-->

ãªã®ã§ã€è¨˜äº‹ã®ä¸­ã«æ›¸ã„ãŸå†…å®¹ã‚‚è‡ªåˆ†ã®ç’°å¢ƒã§ã¯ä»Šã®ã¨ã“ã‚ã†ã¾ãã„ã£ã¦ã„ã¾ã™ãŒã€ã‚‚ã—ã‹ã—ãŸã‚‰åˆ¥ã®ç’°å¢ƒã§ã¯ã†ã¾ãã„ã‹ãªã‹ã£ãŸã‚Šã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚ã—ã‹ã‚‰ãšğŸ‘·

ã¨ã‚Šã‚ãˆãšå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¸ã‚§ãƒãƒ¬ãƒ¼ãƒˆã€‚

```
$ itamae g ruby
```

ã§ã€ã¨ã‚Šã‚ãˆãšæœ€å¾Œã«ã¯ã“ã‚“ãªæ„Ÿã˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã«ãªã‚Šã¾ã™ğŸŒ²

```
â”œâ”€â”€ cookbooks
â”‚   â””â”€â”€ initialize
â”‚       â”œâ”€â”€ default.rb
â”‚       â””â”€â”€ files
â”‚           â””â”€â”€ rbenv.sh
â””â”€â”€ node.yml
```

ã²ã¨ã¾ãšå®Œæˆã—ãŸdefault.rbã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```ruby
package "ruby-rdoc"
package "ruby-devel"
package "epel-release"
package "gcc"
package "gcc-c++"
package "make"
package "automake"
package "autoconf"
package "curl-devel"
package "openssl-devel"
package "libyaml-devel"
package "libxml2-devel"
package "libxslt-devel"
package "libffi-devel"
package "readline-devel"
package "zlib-devel"
package "httpd-devel"
package "sqlite-devel"
package "apr-util-devel"
package "bison"
package "flex"
package "git"
package 'nodejs'

RBENV_DIR = "/usr/local/rbenv"
RBENV_SCRIPT = "/etc/profile.d/rbenv.sh"
RUBY_VER = node["ruby"]["version"]

git RBENV_DIR do
  repository "git://github.com/rbenv/rbenv.git"
end

remote_file RBENV_SCRIPT do
  source "./files/rbenv.sh"
end

execute "set owner and mode for #{RBENV_SCRIPT} " do
  command "chown root: #{RBENV_SCRIPT}; chmod 644 #{RBENV_SCRIPT}"
  user "root"
end

execute "mkdir #{RBENV_DIR}/plugins" do
  not_if "test -d #{RBENV_DIR}/plugins"
end

git "#{RBENV_DIR}/plugins/ruby-build" do
  repository "git://github.com/rbenv/ruby-build.git"
end

git "#{RBENV_DIR}/plugins/rbenv-vars" do
  repository "git://github.com/rbenv/rbenv-vars.git"
end

execute "install ruby #{RUBY_VER}" do
  command "source #{RBENV_SCRIPT}; rbenv install #{RUBY_VER}"
  not_if "source #{RBENV_SCRIPT}; rbenv versions | grep #{RUBY_VER}"
end

execute "set global ruby #{RUBY_VER}" do
  command "source #{RBENV_SCRIPT}; rbenv global #{RUBY_VER}; rbenv rehash"
  not_if "source #{RBENV_SCRIPT}; rbenv global | grep #{RUBY_VER}"
end
```

node.ymlã«ã¯Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã ã‘ã‚’æ›¸ãã¾ã™ã€‚è¤‡æ•°ã®rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›¸ã„ã¦eachã§ã„ãã¤ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ¬ã‚·ãƒ”ã‚’çµæ§‹è¦‹ã¾ã™ãŒã€ã¾ã‚1ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³1ã‚µãƒ¼ãƒãƒ¼ãªäºˆå®šã ã—ã€ã²ã¨ã¾ãšæœ€æ–°ã®2.3.0ã ã‘å…¥ã‚Œã‚‹äº‹ã«ã€‚

```yaml
ruby:
  version: 2.3.0
```

ã§ã€filesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹rbenv.shã®ä¸­èº«ã¯ã„ã¤ã‚‚ã ã£ãŸã‚‰.zshrcã¨ã‹.bashrcã¨ã‹ã«æ›¸ãå†…å®¹ã§ã™ã€‚

```sh
export RBENV_ROOT="/usr/local/rbenv"
export PATH="${RBENV_ROOT}/bin:${PATH}"
eval "$(rbenv init -)"
```

ã“ã„ã¤ã‚’rbenvã‚³ãƒãƒ³ãƒ‰ã‚’Itamaeã§ä½¿ã†ã¨ãã«èª­ã¿è¾¼ã‚“ã§ä½¿ã‚ãªã„ã¨ã†ã¾ãã„ã‹ãªã‹ã£ãŸã§ã™ã€‚

## rbenv.shã‚’è»¢é€ã™ã‚‹

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«é–¢ã—ã¦ã¯ç‰¹åˆ¥æ›¸ãäº‹ãªã„ã®ã§ã‚¹ãƒ«ãƒ¼ã€‚

filesã«ç”¨æ„ã—ãŸã²ã¨ã¾ãšrbenv.shã‚’ã‚µãƒ¼ãƒãƒ¼ã«è»¢é€ã—ã¾ã™ã€‚

```ruby
RBENV_SCRIPT = "/etc/profile.d/rbenv.sh"
remote_file RBENV_SCRIPT do
  source "./files/rbenv.sh"
end
```

## åŸºæœ¬çš„ãªrbenvã‚’githubã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹

Rubyç’°å¢ƒã¯rbenv+ruby-buildã§ä½œã‚Šã¾ã™ã€‚ã§ã€rbenvã¯gitã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãã¾ã™ã€‚ã§ã€pluginç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œã£ã¦ä»–ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

```ruby
RBENV_DIR = "/usr/local/rbenv"

git RBENV_DIR do
  repository "git://github.com/rbenv/rbenv.git"
end

execute "mkdir #{RBENV_DIR}/plugins" do
  not_if "test -d #{RBENV_DIR}/plugins"
end

git "#{RBENV_DIR}/plugins/ruby-build" do
  repository "git://github.com/rbenv/ruby-build.git"
end

git "#{RBENV_DIR}/plugins/rbenv-vars" do
  repository "git://github.com/rbenv/rbenv-vars.git"
end
```

ã§ã€rubyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

```ruby
execute "install ruby #{RUBY_VER}" do
  command "source #{RBENV_SCRIPT}; rbenv install #{RUBY_VER}"
  not_if "source #{RBENV_SCRIPT}; rbenv versions | grep #{RUBY_VER}"
end

execute "set global ruby #{RUBY_VER}" do
  command "source #{RBENV_SCRIPT}; rbenv global #{RUBY_VER}; rbenv rehash"
  not_if "source #{RBENV_SCRIPT}; rbenv global | grep #{RUBY_VER}"
end
```

ã“ã‚Œã§ã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•ã¨ã‹ã™ã‚Œã°ã€ã²ã¨ã¾ãšrubyã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

# Itamaeè‡ªåˆ†ãƒ¡ãƒ¢

  * åŸºæœ¬çš„ãªè¨­å®šã¨ã‹æº–å‚™
  * å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨sshã¨ã‹portã¨ã‹
  * Ruby(rbenv+ruby-build)ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  * Postgresqlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š
  * nginxã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«&ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
