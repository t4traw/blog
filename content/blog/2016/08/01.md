---
title: Itamaeè‡ªåˆ†ãƒ¡ãƒ¢[1]ã€€userã¨ã‹sshã¨ã‹portã®åˆæœŸè¨­å®š
categories:
  - linux
tags:
  - itamae
  - centos
  - nginx
  - puma
image:
---
vpsã«é©å½“ã«sshã§ã¤ãªã’ã‚‹äº‹ãŒç¢ºèªã§ããŸã‚‰ã€userã¨ã‹sshã¨ã‹portã®åˆæœŸè¨­å®šã‚’ã—ã¾ã™ã€‚

<!--more-->

ã¤ã„ã§ã«åˆæœŸçŠ¶æ…‹ã§å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(gitãªã©)ã‚‚ã“ã“ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¡ã‚ƒã„ã¾ã™â©

itamaeã®ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆã€‚

```
$ itamae g initialize
```

ã‚ã¨ç’°å¢ƒæ¯ã«å¤‰ã‚ã‚‹å€¤ã¯node.ymlã«è¨˜è¿°ã—ã¾ã™ã€‚

```
$ touch node.yml
```

ãã—ãŸã‚‰ã“ã‚“ãªå…·åˆã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```
â”œâ”€â”€ cookbooks
â”‚   â””â”€â”€ initialize
â”‚       â”œâ”€â”€ default.rb
â”‚       â”œâ”€â”€ files
â”‚       â”‚   â””â”€â”€ .keep
â”‚       â””â”€â”€ templates
â”‚           â””â”€â”€ .keep
â””â”€â”€ node.yml
```

ä»Šå¾Œã‚‚ã“ã‚“ãªæ„Ÿã˜ã§æœ€åˆã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¸ã‚§ãƒãƒ¬ãƒ¼ãƒˆã—ã€å¯å¤‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã«é–¢ã—ã¦ã¯node.ymlã«è¿½åŠ ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

##

ã¨ã„ã†ã‚ã‘ã§ã€ã²ã¨ã¾ãšå®Œæˆã—ãŸã®ã‚’ã–ã£ã¨æ›¸ã„ã¦ã¿ã‚‹ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚çš„ãªæ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜ã€‚.keepã—ã‹ãªã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯é™¤å¤–ã—ã¦ã‚ã‚Šã¾ã™ã€‚

```
â”œâ”€â”€ cookbooks
â”‚   â””â”€â”€ initialize
â”‚       â”œâ”€â”€ default.rb
â”‚       â””â”€â”€ templates
â”‚           â””â”€â”€ iptables
â””â”€â”€ node.yml
```

ã§ã€default.rbã®ä¸­èº«ãŒã“ã‚“ãªå…·åˆã€‚

```ruby
package 'git'
package 'curl'
package 'wget'
package 'openssh-clients'

USER_NAME = node[:user][:name]
PASSWORD = node[:user][:password]
WHEEL_ID = "10"

user USER_NAME do
  password PASSWORD
end

user USER_NAME do
  gid WHEEL_ID
end

remote_file '/etc/sudoers.d/user' do
  source "./files/user"
end

directory "/home/#{USER_NAME}/.ssh" do
  owner USER_NAME
  group USER_NAME
  mode "700"
end

file "/home/#{USER_NAME}/.ssh/authorized_keys" do
  content node["ssh"]["key"]
  owner USER_NAME
  group USER_NAME
  mode "600"
end

file "sshd_config" do
  path "/etc/ssh/sshd_config"
  action :edit
  block do |content|
    content.gsub!(/^.?Port .+$/, "Port #{node["ssh"]["port"]}")
    content.gsub!(/^.?PermitRootLogin .+$/, "PermitRootLogin no")
    content.gsub!(/^PasswordAuthentication .+$/, "PasswordAuthentication no")
    content.gsub!(/^UsePAM .+$/, "UsePAM no")
  end
end

service "sshd" do
  subscribes :restart, "file[sshd_config]"
end

remote_file 'iptables' do
  path "/etc/sysconfig/iptables"
  source "./files/iptables"
  mode "600"
end

service "iptables" do
  subscribes :restart, "remote_file[iptables]"
end

service 'iptables' do
  action [:enable, :start, :restart]
end
```

ã§ã€node.ymlã¯ã“ã‚“ãªå…·åˆã€‚

```yaml
user:
  name: "rails"
  password: "$6$salt$IxDD3jeSOb5eB1CX5LBsqZFVkJdido3OUILO5Ifz5iwMuTS4XMS130MTSuDDl3aCI6WouIL9AjRbLCelDCy.g."
```

ã§ã¯ã€ç´°ã‹ã„éƒ¨åˆ†ã‚’æ•°é€±é–“å‰ã®è‡ªåˆ†ã®ãŸã‚ã«æ›¸ã„ã¦ãŠãã€‚curlã¨ã‹gitã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãŸã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã ã‘ãªã®ã§ã€èª¬æ˜ã¯çœãã¾ã™ã€‚

## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã¯ã€

```ruby
USER_NAME = node[:user][:name]
PASSWORD = node[:user][:password]

user USER_NAME do
  password PASSWORD
end
```

ä¸€è¦‹ã‚·ãƒ³ãƒ—ãƒ«ãªã‚“ã ã‘ã©ã€userã‚’ä½œã‚‹ã¨ãã®passwordã¯cryptã§æš—å·åŒ–ã•ã‚ŒãŸã‚‚ã®ã§ãªã„ã¨ãƒ€ãƒ¡ã€‚ãªã®ã§ã€

```
$ gem i unix-crypt
```

ã¨æš—å·åŒ–ã™ã‚‹ãŸã‚ã®gemã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€

```
$ mkunixcrypt -s "salt"
```

ã¨ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¦ã°å¯¾è©±å¼ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã€æš—å·åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’node.ymlã®æ–¹ã«ã‚³ãƒ”ãƒšã—ã¾ã™ã€‚

## æ–°ã—ãä½œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§sudo

æ–°ã—ãä½œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§sudoã§ãã‚‹ã‚ˆã†ã«wheelã‚°ãƒ«ãƒ¼ãƒ—ã®idã‚’è¨­å®šã—ã€/etc/sudoers.d/ã®ä¸­ã«wheelã‚°ãƒ«ãƒ¼ãƒ—ã«æ¨©é™ã‚’ä¸ãˆã¾ã™ã€‚ãªãŠã€ã“ã®wheelã‚°ãƒ«ãƒ¼ãƒ—ã®id10ã¨ã„ã†ã®ã¯CentOSã¨ã„ã†ã‹RedHatç³»ï¼Ÿã ã‘ã£ã½ã„ã®ã§æ³¨æ„ã€‚å…·ä½“çš„ã«ã¯Ubuntuã¯ã‚°ãƒ«ãƒ¼ãƒ—åã¨ã‹æƒãˆãªã„ã¨ã„ã‘ãªã„ã®ã§ã€ã“ã®æ–¹æ³•ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

ã¾ãŸã€ä¸€åº¦userã‚’ä½œæˆã—ã¦ã‹ã‚‰ã€å†åº¦ã‚°ãƒ«ãƒ¼ãƒ—idã‚’è¨­å®šã—ãªã„ã¨ã„ã‘ãªã„ã®ã§ã€ãã‚Œã‚‚æ³¨æ„ã§ã™ğŸ’…

```ruby
WHEEL_ID = "10"
user USER_NAME do
  gid WHEEL_ID
end
```

## sshã®å…¬é–‹éµã®ç™»éŒ²ã¨sshd_config

sshã®ã‚­ãƒ¼ãƒšã‚¢ã‚’äºˆã‚ä½œã£ã¦ãŠãã€node.ymlã«å…¬é–‹éµã®ä¸­èº«ã‚’è¨˜è¿°ã—ã¾ã™ã€‚ã‚ã¨ã€sshã®ãƒãƒ¼ãƒˆã‚‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã«å¤‰æ›´ã™ã‚‹ã®ã§ã€æ–°ã—ã„ãƒãƒ¼ãƒˆã‚‚æ›¸ã„ã¦ãŠãã¾ã™ã€‚

```yaml
ssh:
  key: "ssh-rsa é•·ã„æ–‡å­—åˆ—"
  port: 1234
```

ã§ã€sshã®å…¬é–‹éµã®ç™»éŒ²ã¨sshd_configã‚’è¨­å®šã—ã¾ã™ã€‚

```ruby
directory "/home/#{USER_NAME}/.ssh" do
  owner USER_NAME
  group USER_NAME
  mode "700"
end

file "/home/#{USER_NAME}/.ssh/authorized_keys" do
  content node["ssh"]["key"]
  owner USER_NAME
  group USER_NAME
  mode "600"
end

file "sshd_config" do
  path "/etc/ssh/sshd_config"
  action :edit
  block do |content|
    content.gsub!(/^.?Port .+$/, "Port #{node["ssh"]["port"]}")
    content.gsub!(/^.?PermitRootLogin .+$/, "PermitRootLogin no")
    content.gsub!(/^PasswordAuthentication .+$/, "PasswordAuthentication no")
    content.gsub!(/^UsePAM .+$/, "UsePAM no")
  end
end

service "sshd" do
  subscribes :restart, "file[sshd_config]"
end
```

## iptablesã®è¨­å®š

æ¥ç¶šã§ãã‚‹ãƒãƒ¼ãƒˆã‚’å¿…è¦ãªã‚‚ã®ã ã‘ã«ã™ã‚‹ãŸã‚ã«iptablesã‚’è¨­å®šã—ã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã®/initialize/templatesã®ä¸­ã«iptablesã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ã“ã‚“ãªæ„Ÿã˜ã§æ›¸ãã¾ã™ã€‚ã²ã¨ã¾ãšåŸºæœ¬ã®80ã¨443ãƒãƒ¼ãƒˆã ã‘é–‹ã‘ã¦ã€ã•ãã»ã©è¨­å®šã—ãŸsshã®ãƒãƒ¼ãƒˆã‚’é–‹ã‘ãŸã ã‘ãªã®ã§ã€å¿…è¦ãŒã‚ã‚Œã°è¨­å®šã‚’æ›¸ããªãŠã™æ„Ÿã˜ã§ãŠé¡˜ã„ã—ã¾ã™ğŸ˜„

```
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp ! --syn -m state --state NEW -j DROP
-A INPUT -p tcp --tcp-flags ALL ALL -j DROP
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport <%= node["ssh"]["port"] %> -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
```

ã§ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’/etc/sysconfig/iptablesã«ç½®ãã¾ã™ã€‚

```ruby
template 'iptables' do
  path "/etc/sysconfig/iptables"
  source "./templates/iptables"
  mode "600"
end

service "iptables" do
  subscribes :restart, "remote_file[iptables]"
end
```

æ¬¡ã¯Rubyã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ã—ã¾ã™ã€‚

# Itamaeè‡ªåˆ†ãƒ¡ãƒ¢

  * åŸºæœ¬çš„ãªè¨­å®šã¨ã‹æº–å‚™
  * å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨sshã¨ã‹portã¨ã‹
  * Ruby(rbenv+ruby-build)ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  * Postgresqlã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®š
  * nginxã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«&ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
