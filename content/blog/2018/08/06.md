---
title: Yahooã®æ–°ç€æƒ…å ±ã‚’goã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°(å®šæœŸå‡¦ç†)ã—ã¦jsonã‚’AWS Lambdaã§å‡ºåŠ›ã™ã‚‹
categories:
  - aws
  - yahoo
tags:
  - go
  - aws
  - lambda
  - json
	- yahoo
image: 
---
ECDOã®æ–°ç€æƒ…å ±ã®è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½ã‚’ä½œæˆä¸­ã€APIã§æ–°ç€æƒ…å ±ã‚’å–å¾—ã™ã‚‹å‰æã§ã„ã¾ã—ãŸãŒã€Yahooã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°APIã«ãã‚“ãªã‚‚ã®ã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸğŸ˜¢ (æ™®æ®µã¯ç¤¾å†…ã®æ©Ÿé–¢ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰æ–°ç€å•†å“ã‚’å–å¾—ã—ã¦ã„ã‚‹ã—ã€å½“ç„¶ã‚ã‚‹ã‚‚ã®ã ã¨æ€ã„ã“ã‚“ã§ã„ãŸ)

<!--more-->

ãƒ—ãƒ©ã‚¤ãƒãƒªã®idã¨ã‹ç™»éŒ²æ—¥ã¿ãŸã„ãªãƒ‡ãƒ¼ã‚¿ã§ã‚½ãƒ¼ãƒˆã—ã¦æœ€æ–°nä»¶ãã‚Œã‚‹ã ã‘ã§ã„ã„ã®ã«ï¼ã¨æ³£ããŸã„ã¨ã“ã‚ã§ã™ã€‚ã†ãƒ¼ã‚“ã€ã˜ã‚ƒã‚ã©ã†ã‚„ã£ã¦æ–°ç€æƒ…å ±ã‚’å–å¾—ã—ã‚ˆã†ã€‚ã¨è‰²ã€…è¦‹ã¦ã„ã‚‹ã¨ã€ã‚·ãƒ§ãƒƒãƒ—å†…æ¤œç´¢ã«æ–°ç€é †ã¨ã„ã†ã‚½ãƒ¼ãƒˆã‚’ç™ºè¦‹ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ã€æ‰±ã„ã‚„ã™ã„jsonã«ã™ã‚Œã°ä½¿ãˆãã†ã§ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€ã•ã£ããã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã€‚ã§ã™ãŒã€æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã«workerã‚„ã‚¸ãƒ§ãƒ–å‡¦ç†ç’°å¢ƒã‚’ã¾ã ä½œã£ã¦ã„ãªã„ã—ã€ã“ã“ã¯æ°—ã«ãªã£ã¦ã„ãŸAWS Lambdaã‚’ä½¿ã£ã¦ã€ã‚µã‚¯ã£ã¨å®šæœŸå‡¦ç†ã‚’ã—ã¦ã¿ã‚‹äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

ãŸã¾ã«éŠã¶ç¨‹åº¦ã§goã‚’è§¦ã£ã¦ã„ã¾ã™ãŒã€goæ¥½ã—ã„ã§ã™ã‚ˆã­ã€‚rubyã‚’è§¦ã£ã¦ã„ã‚‹æ™‚ã¨ã¯ã¾ãŸåˆ¥ã®æ¥½ã—ã•ãŒã‚ã‚Šã¾ã™ã€‚

htmlã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã«ã¯goqueryã‚’ä½¿ã‚ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ã¨ã‚Šã‚ãˆãšã‚µã‚¯ã£ã¨ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã“ã¡ã‚‰ã€‚

```go
package main

import (
	"github.com/PuerkitoBio/goquery"
)

// Item å„å•†å“ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿
type Item struct {
	URL   string `json:"url"`
	Image string `json:"image"`
	Title string `json:"title"`
}

// OutputJSON å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿
type OutputJSON []Item

func scrape(target string) (OutputJSON, error) {
	var url, image, title string
	var outputs OutputJSON

	html, _ := goquery.NewDocument(target)
	html.Find(".elWrap").Each(func(_ int, block *goquery.Selection) {
		block.Find(".elImage").Find("a").Each(func(_ int, s *goquery.Selection) {
			url, _ = s.Attr("href")
		})
		block.Find(".elImage").Find("img").Each(func(_ int, s *goquery.Selection) {
			image, _ = s.Attr("src")
		})
		block.Find(".elImage").Find("img").Each(func(_ int, s *goquery.Selection) {
			title, _ = s.Attr("alt")
		})
		item := Item{
			URL:   url,
			Image: image,
			Title: title,
		}
		outputs = append(outputs, item)
	})

	return outputs, nil
}

func main() {
	url := "https://store.shopping.yahoo.co.jp/YOUR_SHOP_NAME/search.html?p=&ei=UTF-8&x=59&y=8&X=99#CentSrchFilter1"
	fmt.Println(scrape(url))
}
```

YOUR_ASHOP_NAMEã®éƒ¨åˆ†ã¯å®Ÿéš›ã®åº—èˆ—ã«åˆã‚ã›ã¦ãã ã•ã„ã­ã€‚

ã²ã¨ã¾ãšã“ã‚Œã§èµ°ã‚‰ã›ã¦ã¿ã‚‹ã¨ã€æ€ã„é€šã‚Šã®çµæœãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

ã“ã‚Œã‚’AWS Lambdaã§èµ°ã‚‰ã›ã¦ã¿ã¾ã™ã€‚ãã®ãŸã‚ã«ä¸€éƒ¨ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

1. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸(`"github.com/aws/aws-lambda-go/lambda"`)ã‚’go getã—ã¦import
2. urlã‚’å®Ÿè¡Œæ™‚ã«æ¸¡ã™ã‚ˆã†ã«å¤‰æ›´ã€‚ãã®ãŸã‚ã®æ§‹é€ ä½“ã‚’è¿½åŠ 
3. scrapeé–¢æ•°ã®å¼•æ•°ã‚’æ§‹é€ ä½“ã«å¤‰æ›´ã—ã€å†…éƒ¨ã§ã®å‘¼ã³å‡ºã—ã‚‚å¤‰æ›´

```go
package main

import (
	"github.com/PuerkitoBio/goquery"
	"github.com/aws/aws-lambda-go/lambda"
)

// InputJSON å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
type InputJSON struct {
	URL string `json:"url`
}

// Item å„å•†å“ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒ‡ãƒ¼ã‚¿
type Item struct {
	URL   string `json:"url"`
	Image string `json:"image"`
	Title string `json:"title"`
}

// OutputJSON å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿
type OutputJSON []Item

func scrape(target InputJSON) (OutputJSON, error) {
	var url, image, title string
	var outputs OutputJSON

	html, _ := goquery.NewDocument(target.URL)
	html.Find(".elWrap").Each(func(_ int, block *goquery.Selection) {
		block.Find(".elImage").Find("a").Each(func(_ int, s *goquery.Selection) {
			url, _ = s.Attr("href")
		})
		block.Find(".elImage").Find("img").Each(func(_ int, s *goquery.Selection) {
			image, _ = s.Attr("src")
		})
		block.Find(".elImage").Find("img").Each(func(_ int, s *goquery.Selection) {
			title, _ = s.Attr("alt")
		})
		item := Item{
			URL:   url,
			Image: image,
			Title: title,
		}
		outputs = append(outputs, item)
	})

	return outputs, nil
}

func main() {
	lambda.Start(scrape)
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’**scrape.go**ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«åã§ä¿å­˜ã—ã¾ã™ã€‚ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã—ã¦å®Ÿéš›ã«å©ãé–¢æ•°åã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚ã‚ã›ã¦ãŠã‹ãªã„ã¨ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

ã“ã‚Œã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```
GOOS=linux GOARCH=amd64 go build -o scrape
```

å®Œæˆã—ãŸãƒã‚¤ãƒŠãƒªã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«zipã«ã—ã¾ã™ã€‚

```
zip handler.zip ./scrape
```

å®Œæˆã—ãŸã‚‰ã€ã„ã‚ˆã„ã‚ˆAWS Lambdaã§å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚AWS Lambdaã®é–¢æ•°ã‚’æ–°ã—ãä½œæˆã‚’ã—ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ãŸã‚‰ä¿å­˜ã‚’ã—ã¾ã™ã€‚

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/2018-08-06_16-24-37.png)

ãã—ãŸã‚‰ã€ã•ã£ãããƒ†ã‚¹ãƒˆã‚’ã—ã¦ã¿ã¾ã™ã€‚ä¸Šéƒ¨ã«ã‚ã‚‹ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/2018-08-06_16-27-56.png)

é©å½“ãªãƒ†ã‚¹ãƒˆåã¨jsonã‚’æ›¸ã„ã¦ä¿å­˜ã‚’ã—ã¾ã™ã€‚

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/2018-08-06_16-29-18.png)

å†åº¦ä¸Šã®ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã¿ã‚‹ã¨ã€

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/2018-08-06_16-30-27.png)

ç„¡äº‹ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼ã†ã‚Œã—ã„ğŸ˜­

ã“ã‚Œã‚’å®šæœŸçš„ã«å›ã—ã¦ã€jsonã‚’é©å½“ãªå ´æ‰€ã«ä¿ç®¡ã—ã¦ãŠã‘ã°è‰¯ã•ãã†ã§ã™ã€‚

ã—ã‹ã—ã€ã“ã†ã„ã†å®šæœŸå‡¦ç†ã ã£ãŸã‚‰ã€AWS Lambdaã‚’ä½¿ãˆã°è¶…ãƒ©ã‚¯ãƒãƒ³ã€‚ã‹ã¤goã§ãƒã‚¤ãƒŠãƒªã‚’ä½œã‚‹ã‹ã‚‰ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚‚é€Ÿã„ã€‚æœ¬å½“ã«ã™ã”ã„æ™‚ä»£ã«ãªã‚Šã¾ã—ãŸã€‚
