---
title: ActiveJob, sidekiq, sidekiq-schedulerã‚’ä½¿ã£ã¦Railsã§å®šæœŸå‡¦ç†
date: 2018-09-11
archives: ["2018/09"]
categories:
  - é–‹ç™º
tags:
  - rails
  - active_job
  - sidekiq
image: sidekiq.png
---
Railsã§ä½•ã‹ä½œã‚‹æ™‚ã€ã»ã¼ãƒãƒƒã‚¯ã‚°ãƒ©ãƒ³ãƒ‰å‡¦ç†ã‚’æ¯å›ä½œã£ã¦ã„ã‚‹ã®ã§ã€åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åŠ ãˆã‚ˆã†ã¨æ±ºæ„ã—ãŸä»Šæ—¥ã“ã®ã”ã‚ã€‚Rails4.2ã‹ã‚‰å°å…¥ã•ã‚Œã¦ã„ã‚‹ActiveJobã¨Sidekiqã€ãã—ã¦ãã‚Œã‚’cronã®ã‚ˆã†ã«å®šæœŸå®Ÿè¡Œã—ã¦ãã‚Œã‚‹sidekiq-schedulerã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’æ›¸ã„ã¦ãŠãã¾ã™ğŸ“

<!--more-->

## ç’°å¢ƒ

- ruby: 2.5.1
- rails: 5.2.0
- redis

RedisãŒãªã„å ´åˆã¯ã‚µã‚¯ã£ã¨`brew install redis`ãªã©ã—ã¦ãã ã•ã„ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«&æº–å‚™

ã¨ã‚Šã‚ãˆãšå¿…è¦ãªgemã‚’ã‚¶ã‚¶ã£ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

###### Gemfile
```ruby
gem 'sidekiq'
gem 'sidekiq-scheduler'
gem 'sinatra', require: false
```

sinatraã¯Sidekiqã®ã‚¸ãƒ§ãƒ–ã®ç®¡ç†ç”»é¢ã«åˆ©ç”¨ã—ã¾ã™ã€‚

æ¬¡ã«ã€config/environments/å„ç’°å¢ƒ.rbã®ä¸­ã«

```
config.active_job.queue_adapter = :sidekiq
```

ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

## ActiveJob+Sidekiqã‚’ä½¿ã£ã¦ã¿ã‚‹

ActiveJobã‚’ä½¿ã†ã®ã§ã€ã‚³ãƒãƒ³ãƒ‰ã¯ã™ã”ãç°¡å˜

```
$ rails g job hello_sidekiq
```

ã§ã€app/jobs/hello_job.rbãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚è©¦ã—ã«å‹•ã‹ã™ãŸã‚ã«é©å½“ãªputsã‚’æ›¸ãã¾ã™ã€‚

###### app/jobs/hello_job.rb
```ruby
class HelloSidekiqJob < ApplicationJob
  def perform(args)
    puts args
  end
end
```

è©¦ã—ã«railsã¨redisã¨sidekiqã‚’èµ·å‹•ã•ã›ã€`rails c`ã‚‚ã—ãã¯`rails runnner`ã§Jobã‚’ã‚­ãƒƒã‚¯ã—ã¦ã¿ã¾ã™ã€‚

```
$ rails runner "HelloSidekiqJob.perform_later('hoge')"
```

ã™ã‚‹ã¨ã€ç„¡äº‹å‡ºåŠ›ã«hogeã¨ã„ã†æ–‡å­—ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸğŸ‰ ã‚“ãƒ¼ã€ç°¡å˜ï¼

æ™‚é–“ã‚’ç½®ã„ã¦å‡¦ç†ã—ãŸã„å ´åˆã¯

```ruby
HelloSidekiqJob.set(wait: 1.min).perform_later('hoge')
```

ã¨ã„ã£ãŸå…·åˆã«æ›¸ãã¾ã™ã€‚

## sidekiq-shcedulerã‚’ä½¿ã£ã¦å®šæœŸå‡¦ç†ã‚’ã™ã‚‹

ã“ã“ã‹ã‚‰sidekiq-schedulerã‚’èµ·å‹•ã™ã‚‹ã®ã¯éå¸¸ã«ç°¡å˜ã§ã™ã€‚

gemã¯æœ€åˆã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã‚ã‚‹ã®ã§ã€config/sidekiq.ymlã‚’ç”Ÿæˆã—ã€

###### config/sidekiq.yml
```yml
:schedule:
  HelloSidekiqJob:
    every: 1m
    args: "Hello sidekiq-scheduler!!"
```

ã¨æ›¸ãã ã‘ã§ã€ä¸Šè¨˜ã®ymlã ã¨1åˆ†ã”ã¨ã«`Hello sidekiq-scheduler!`ã¨å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚

## ç®¡ç†ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹

config/routes.rbã«è¿½åŠ ã™ã‚‹ã ã‘ã§ã€ã‚µã‚¯ã£ã¨ç®¡ç†ç”»é¢ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚ã§ã‚‚ã€æœ¬ç•ªãªã©ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ãˆã‚‹ã®ã¯è‰¯ããªã„ã®ã§ã€ã¨ã‚Šã‚ãˆãšã‚µã‚¯ã£ã¨Basicèªè¨¼ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

###### config/routes.rb
```ruby
Rails.application.routes.draw do
  require 'sidekiq/web'
  require 'sidekiq-scheduler/web'

  Sidekiq::Web.use Rack::Auth::Basic do |username, password|
    username == 'YOUR_NAME' && password == 'YOUR_PASSWORD'
  end
  mount Sidekiq::Web, at: "/sidekiq"

  #~~çœç•¥~~
end
```

ã“ã‚Œã§ http://localhost:3000/sidekiq ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°ã€sidekiqã®ã‚­ãƒ¥ãƒ¼ç®¡ç†ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](/images/2018-09-11_12-04-00.png)

recurning_jobsã¨ã„ã†ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€schedulerã®ã‚­ãƒ¥ãƒ¼ã‚’ç®¡ç†ã™ã‚‹ç”»é¢ãŒè¡¨ç¤ºã§ãã¾ã™ã€‚

![](/images/2018-09-11_12-05-09.png)

ã„ã‚„ããƒ¼ã€ä¾¿åˆ©ï¼ä¸€æ™‚åœæ­¢ã¨ã‹ã‚‚ã“ã“ã§ã§ãã‚‹ã®ãŒç´ æ™´ã‚‰ã—ã„ğŸ‘

---
ã¨ã„ã†ã‚ã‘ã§ã€ActiveJob+sidekiq+sidekiq-schedulerã®ç°¡å˜ãªä½¿ã„æ–¹ã§ã—ãŸã€‚ã“ã‚Œè‡ªåˆ†ãŒã„ã¤ã‚‚ä½¿ã†åˆæœŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚‚ã†å…¥ã‚Œã¦ãŠã“ã†ã‹ãªãã€‚
