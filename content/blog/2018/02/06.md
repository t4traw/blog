---
title: middlemanã¨webpackã§ãƒ¢ãƒ€ãƒ³ãªé™çš„ã‚µã‚¤ãƒˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œã‚‹
date: 2018-02-06
categories:
  - middleman
tags:
  - middleman
  - webpack
image: https://t4traw.s3-ap-northeast-1.amazonaws.com/dropshare/dqg8fMcM4UAxQthf4zS1nVZd5K4Z6OMn.png
---
middleman + webpackãªæœ€æ–°ã®é™çš„ã‚µã‚¤ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

ã¡ãªã¿ã«ä»Šå›ä½œã£ãŸã‚‚ã®ã¯ã“ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒªã«pushã—ã¦ãŠãã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã©ã®ç´°ã‹ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ãƒªãƒã‚¸ãƒˆãƒªè¦‹ã‚Œã°ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

[t4traw/middleman-webpack-sample](https://github.com/t4traw/middleman-webpack-sample)

<!--more-->

### 2019å¹´6æœˆæ›´æ–°

webpackã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã€è»½é‡åŒ–ãƒ»é«˜é€ŸåŒ–ãªã©ã‚’è¦–é‡ã«å…¥ã‚Œã¦ã€æ›´æ–°ã—ã¾ã—ãŸã€‚

## ğŸ“ ä»Šå›ã‚„ã£ãŸã“ã¨

- middleman + webpackã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- cssã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã™ã‚‹
- autoprefixerã§prefixã‚’ä»˜ã‘ã‚‹
- cssã‚’minifyã™ã‚‹
- ä½¿ã£ã¦ã„ãªã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹

## ğŸŒ± äº‹å‰æº–å‚™

ä»Šå›ã¯webpackã‚’ä½¿ã†ã®ã§ã€nodejsãŒå¿…è¦ã§ã™ã€‚ã¾ãŸåƒ•ã¯yarnã‚’ä½¿ç”¨ã—ãŸã®ã§ã€yarnã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚Macç’°å¢ƒã®æ–¹ã¯brewã‹ã‚‰ã‚µã‚¯ã£ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

```
$ brew intall node
$ brew intall yarn
```

## ğŸ”§ middlemanã¨webpackã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã¯Gemfileã‚’ã‚µã‚¯ã£ã¨æº–å‚™ã€‚

```
$ mkdir YOUR_SITE_NAME && cd $_
$ bundle init
```

Gemfileã®ä¸­ã«middlemanã‚’æ›¸ãè¾¼ã¿ã¾ã™ã€‚

<div class="filename">Gemfile</div>

```ruby
gem "middleman"
```

ãã—ã¦bundle installã—ã¾ã™ã€‚

```
$ bundle install
```

middlemanãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‚‰ã€middleman newã—ã¾ã™ã€‚

```
$ middleman new .
```

ã“ã®æ®µéšã§.gitignoreãŒç”Ÿæˆã•ã‚Œã¾ã™ãŒã€node_modulesãªã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¥ã£ã¦ã„ãªã„ã®ã§ã€ã‚µã‚¯ã£ã¨.gitignoreã‚’ç”Ÿæˆã—ãªãŠã—ã¾ã™ã€‚

```
$ rm -f .gitignore && curl https://www.gitignore.io/api/node%2Csass%2Cruby%2Cmacos%2Cgrunt > .gitignore
```

webpackã‚’ä½¿ã†ãŸã‚ã«package.jsonã‚’ç”¨æ„ã—ã¾ã™ã€‚yarn initã™ã‚‹æ™‚ã«ã„ãã¤ã‹è³ªå•ãŒã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšå…¨éƒ¨Enterã§å¤§ä¸ˆå¤«ã ã¨æ€ã„ã¾ã™ã€‚å¿…è¦ãŒã‚ã‚Œã°å¤‰ãˆã¦ãã ã•ã„ã€‚

```
$ yarn init
```

package.jsonãŒã§ããŸäº‹ã‚’ç¢ºèªã—ãŸã‚‰ã€å¿…è¦ãªnpmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã¾ãšã¯webpackã€‚ãã—ã¦webpack.config.jsã‚’ç”Ÿæˆã—ã¦ãŠãã¾ã™ã€‚

```
$ yarn add -D webpack
$ touch webpack.config.js
```

ã“ã®æ®µéšã§ã¾ãšã¯middlemanã®external_pipelineï¼ˆå¤–éƒ¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼‰ã§webpackãŒå‹•ãã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšmiddlemanã®configã«external_pipelineã‚’ä½¿ã†ã‚ˆã†ã«æ›¸ãã€webpackã®ã‚³ãƒãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã‚¢ã‚»ãƒƒãƒˆã®å–å¾—å…ˆã‚’`source: ".tmp/dist"`ã«ã—ã¦ãŠãã®ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

<div class="filename">config.rb</div>

```ruby
activate :relative_assets
set :relative_links, true

activate :external_pipeline, {
  name: :webpack,
  command: build? ?
    "NODE_ENV=production yarn run build" :
    "NODE_ENV=develop yarn run develop",
  source: ".tmp/dist",
  latency: 1
}
```

ãã—ã¦ã€è¨­å®šã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’package.jsonã«è¿½åŠ ã—ã¾ã™ã€‚

<div class="filename">package.json</div>

```json
{
  "name": "middleman-webpack-sample",
  "version": "1.0.0",
  "main": "index.js",
  "repository": "ssh://git@github.com/t4traw/middleman-webpack-sample.git",
  "author": "Tatsuro Moriyama <t4traw@gmail.com>",
  "license": "MIT",
  "devDependencies": {
    "webpack": "^4.17.1"
  },
  "scripts": {
    "develop": "webpack --config ./webpack.config.js --watch -d --progress --colors",
    "build": "webpack --config ./webpack.config.js --bail -p"
  }
}
```

æœ€å¾Œã«ã€webpackã®è¨­å®šã‚’ã—ã¾ã™ã€‚middlemanã®external_pipelineã®ã‚¢ã‚»ãƒƒãƒˆã®å ´æ‰€ã‚’`source: ".tmp/dist"`ã«ã—ãŸã®ã§ã€webpackã®outputã‚‚ãã“ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

<div class="filename">webpack.config.json</div>

```javascript
const webpack = require('webpack');
module.exports = {
  entry: [
    './source/javascripts/site.js'
  ],
  output: {
    path: __dirname + '/.tmp/dist',
    filename: 'javascripts/bundle.js'
  }
};
```

å„è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šè¨˜ã®ã‚ˆã†ã«ã—ã€ã¨ã‚Šã‚ãˆãšmiddlemanã‚’èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚

```
$ middleman
```

â†“ã¿ãŸã„ãªæ„Ÿã˜ã§è¡¨ç¤ºã•ã‚Œã‚Œã°ã²ã¨ã¾ãšæˆåŠŸã§ã™ã€‚

```
== The Middleman is loading
== Executing: `NODE_ENV=develop yarn run develop`
== View your site at "//localhost:4567", "//127.0.0.1:4567"
== Inspect your site configuration at "//localhost:4567/__middleman", "//127.0.0.1:4567/__middleman"
== External: yarn run v1.3.2
== External: $ webpack --config ./webpack.config.js --watch -d --progress --colors
 10% building modules 1/1 modules 0 active== External: Webpack is watching the filesâ€¦
== External: Hash: 56b513b6e7776f8a5874
== External: Version: webpack 3.10.0
== External: Time: 106ms
== External:                 Asset     Size  Chunks             Chunk Names
== External: javascripts/bundle.js  3.57 kB       0  [emitted]  main
== External:    [0] multi ./source/javascripts/site.js 28 bytes {0} [built]
== External:    [1] ./source/javascripts/site.js 32 bytes {0} [built]
```

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/blog/2018-02-06_13-43-48.png)

èµ·å‹•ã®ç¢ºèªãŒã§ããŸã®ã§ã€ã‚ã¨ã¯javascriptã®èª­ã¿è¾¼ã¿ã‚’layoutã«æ›¸ãã¾ã™ã€‚

<div class="filename">source/layouts/layout.erb</div>

```html
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Use the title from a page's frontmatter if it has one -->
    <title><%= current_page.data.title || "Middleman" %></title>
    <%= stylesheet_link_tag "site" %>
    <%= javascript_include_tag "site" %>
  </head>
  <body>
    <%= yield %>
  </body>
  <%= javascript_include_tag :bundle %>
</html>
```

ã“ã“ã¾ã§ä¸‹æº–å‚™ã€‚webpack.config.jsonã®outputã«æ›¸ãã¾ã—ãŸãŒã€`filename: 'javascripts/bundle.js'`ã¨ã—ã¦ã„ã‚‹ã®ã§ã€bundle.jsã‚’èª­ã¿è¾¼ã‚ã°ã€ã™ã¹ã¦javascriptãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

## ğŸš˜ webpackã§cssã‚’ã„ã„æ„Ÿã˜ã«ã™ã‚‹

å½“åˆã¯style-loaderã§cssã‚‚javascriptã§æç”»ã—ã¦ã„ã¾ã—ãŸãŒã€è»½é‡åŒ–ã‚„é«˜é€ŸåŒ–ã‚’ã™ã‚‹ã¨ãã«åˆ¥ã§å‡ºåŠ›ã™ã‚‹å¿…è¦ãŒã§ã¦ãã¾ã—ãŸã€‚ãªã®ã§ã€sass->cssã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’ã—ãŸå¾Œã«cssãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã‚’æ›¸ãã¾ã™ã€‚

ã¾ãšã¯å¿…è¦ãªã‚‚ã®ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
$ yarn add -D node-sass sass-loader css-loader mini-css-extract-plugin
```

ãã—ã¦webpack.config.jsã«csså‘¨ã‚Šã®è¨­å®šã‚’æ›¸ãã¾ã™ã€‚

<div class="filename">webpack.config.json</div>

```js
const MiniCssExtractPlugin = require('mini-css-extract-plugin')

module.exports = {
  entry: [
    './source/javascripts/site.js'
  ],
  output: {
    path: __dirname + '/.tmp/dist',
    filename: 'javascripts/bundle.js'
  },
  module: {
    rules: [
      {
        test: /\.(css|sass|scss)$/,
        use: [
          MiniCssExtractPlugin.loader,
          "css-loader",
          "sass-loader"
        ]
      },
    ]
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: "[name].css",
    }),
  ]
}
```

ãã—ã¦ã€source/javascripts/site.jsã«cssãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿è¨­å®šã‚’æ›¸ãã¾ã™ã€‚

<div class="filename">source/javascripts/site.js</div>

```javascript
import '../stylesheets/site.css.scss';
```

ã“ã‚Œã§sassã‹ã‚‰ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ãŸmain.cssãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

æœ€å¾Œã«source/layouts/layout.erbã¸main.cssã‚’èª­ã¿è¾¼ã‚€è¨­å®šã‚’æ›¸ãã¾ã™ã€‚

<div class="filename">source/layouts/layout.erb</div>

```html
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Use the title from a page's frontmatter if it has one -->
    <title><%= current_page.data.title || "Middleman" %></title>
  </head>
  <body>
    <%= yield %>
  </body>
  <%= stylesheet_link_tag :main %>
  <%= javascript_include_tag :bundle %>
</html>
```

### autoprefixerã¨minify(csswring, cssnano)ã‚’å°å…¥ã™ã‚‹

ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ã®prefixè¾¼ã¿ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯ã‚‚ã†äººé–“ãŒã‚„ã‚‹äº‹ã§ã¯ãªã„ã®ã§ã€autoprefixerã‚’å°å…¥ã—ã¾ã™ã€‚

ã‚ã¨ã€cssãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ ãƒ€ãªç©ºç™½ã‚„æ”¹è¡Œã‚’å‰Šé™¤ã™ã‚‹ï¼minifyã‚‚ä¸€ç·’ã«ã‚„ã£ã¡ã‚ƒã„ã¾ã™ã€‚

```
$ yarn add -D postcss-loader autoprefixer csswring cssnano
```

webpack.config.jsonã«postcss-loaderã‚’è¿½åŠ ã—ã¾ã™ã€‚

<div class="filename">webpack.config.json</div>

```javascript
ã€œã€œã€œçœç•¥ã€œã€œã€œ
  module: {
    rules: [
      {
        test: /\.(css|sass|scss)$/,
        use: [
          MiniCssExtractPlugin.loader,
          "css-loader",
          {
            loader: 'postcss-loader',
              options: {
                sourceMap: true,
                plugins: [
                  require('autoprefixer')({
                    grid: true
                  }),
                  require('csswring')(),
                  require('cssnano')({
                    preset: 'default',
                  }),
                  
                ]
              },
          },
          'sass-loader',
        ]
      },
    ]
  }
```

ãƒ†ã‚¹ãƒˆã§source/stylesheets/site.css.scssã«`display: flex;`ã‚’è¿½åŠ ã—ã¦ã¿ã¦ã¿ã¾ã™ã€‚

<div class="filename">source/stylesheets/site.css.scss</div>

```css
.foo {
  display: flex;
}
```

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/blog/2018-02-06_14-09-00.png)

ç„¡äº‹minifyã¨ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ğŸ‘

## importã«*ãŒä½¿ãˆã‚‹import-glob-loaderã‚’å°å…¥ã™ã‚‹

scssã§ã‚ã–ã‚ã–æ­£ç¢ºãªãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æ›¸ãã®ã¯éå¸¸ã«é¢å€’ãªã®ã§ã€ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆ*ï¼‰ãŒä½¿ãˆã‚‹import-glob-loaderã‚’å°å…¥ã—ã¾ã™ã€‚

```
$ yarn add -D import-glob-loader
```

ã•ãã»ã©ã®css-loaderãªã©ã¨ã¯åˆ¥ã®ãƒ–ãƒ­ãƒƒã‚¯ã«è¿½åŠ ã—ã¾ã™ã€‚

<div class="filename">webpack.config.json</div>

```js
  module: {
    rules: [
      {
        test: /\.(css|sass|scss)$/,
        use: [
          MiniCssExtractPlugin.loader,
          "css-loader",
          {
            loader: 'postcss-loader',
              options: {
                sourceMap: true,
                plugins: [
                  require('autoprefixer')({
                    grid: true
                  }),
                  require('csswring')(),
                  require('cssnano')({
                    preset: 'default',
                  }),
                  
                ]
              },
          },
          'sass-loader',
        ]
      },
      {
        test: /\.(js|sass|scss)$/,
        enforce: "pre",
        loader: 'import-glob-loader'
      },

      // ~~~çœç•¥~~~
```

ã“ã‚Œã§ã€site.css.scssã«

```scss
@charset "utf-8";

@import "preload/*";
@import "library/*";
@import "components/*";
```

ã¿ãŸã„ãªæ„Ÿã˜ã§é›‘ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®scssãƒ•ã‚¡ã‚¤ãƒ«ã¯ã™ã¹ã¦importã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚


## ä½¿ç”¨ã—ã¦ã„ãªã„cssã‚’å‰Šé™¤ã™ã‚‹PurgeCSSã‚’å°å…¥ã™ã‚‹

æœ€è¿‘ã¯cssãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã‚ãšã«åˆ¶ä½œãƒ»é–‹ç™ºã™ã‚‹äº‹ã¯ãªããªã‚Šã¾ã—ãŸã€‚ã§ã€cssãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã†ã¨ã©ã†ã—ã¦ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãããªã£ã¦ã—ã¾ã†å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

ãªã®ã§ã€è‡ªå‹•çš„ã«ä½¿ç”¨ã—ã¦ã„ãªã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹PurgeCSSã‚’å°å…¥ã—ã¾ã™ã€‚

```
$ yarn add -D purgecss-webpack-plugin
```

<div class="filename">webpack.config.json</div>

```js
const path = require('path')
const glob = require('glob')
const MiniCssExtractPlugin = require('mini-css-extract-plugin')
const PurgecssPlugin = require('purgecss-webpack-plugin')

module.exports = {
  // ~~çœç•¥~~

    plugins: [
    new MiniCssExtractPlugin({
      filename: "[name].css",
    }),
    new PurgecssPlugin({
      paths: glob.sync(`${path.join(__dirname, 'source')}/**/*`, { nodir: true }),
    }),
  ]
}
```

ã“ã‚Œã ã‘ã§ä½¿ã‚ãªã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã‚Œã¾ã™ã€‚

## ğŸ‰ StaticSiteBootstrapã‚’æ›´æ–°ã—ã¦ãŠãã¾ã—ãŸã€‚

ä»Šå›ã®middleman + webpackã‚’[StaticSiteBootstrap](https://github.com/t4traw/static_site_bootstrap)ã«åæ˜ ã•ã›ã¦ãŠãã¾ã—ãŸã€‚

ã“ã†ã—ã¦GitHubã«pushã—ã¦ãŠã‘ã°ã€

```
$ middleman init -T t4traw/static_site_bootstrap
```

ã‚ã¨ã¯ã„ãã¤ã‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç°¡å˜ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ç”Ÿæˆã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚ã‚ˆãé™çš„ã‚µã‚¤ãƒˆã‚’åˆ¶ä½œã™ã‚‹æ–¹ã¯ã“ã‚“ãªå…·åˆã§ã‚µã‚¯ã£ã¨ãƒ™ãƒ¼ã‚¹ã‚’ä½œã‚Œã‚‹ã¨æ¥½ã«èµ°ã‚Šå‡ºã›ã‚‹ã®ã§ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ğŸƒ
