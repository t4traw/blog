---
title: GitHubã‹ã‚‰GitLabã«ç§»è¡Œã—ãŸã®ã§ã€GitLab-CI(Dockerç’°å¢ƒ)ã§Rails+Minitestã‚’HeadlessChromeã§å›ãã†ã¨æ€ã£ãŸã‚‰ã‚ã£ã¡ã‚ƒå¤§å¤‰ã ã£ãŸ
date: 2018-06-07
categories:
  - github
  - gitlab
tags:
  - github
  - gitlab
  - ci
  - rails
  - docker
  - minitest
  - headless_chrome
image: https://s3-ap-northeast-1.amazonaws.com/t4traw/ss/20190513-160002.png
---
GitHubãŒMicrosoftã«è²·åã•ã‚Œã¦ã€GitLabã«ç§»è¡Œã™ã‚‹ã®ãŒãƒ–ãƒ¼ãƒ (ğŸ„â“)ã«ãªã£ã¦ã„ã¾ã™ã€‚

<!--more-->

è‡ªåˆ†ã¨ã—ã¦ã¯æœ€è¿‘ã®Microsoftãªã‹ãªã‹è‰¯ã„ã®ã§ã€ã¾ã‚GitHubã‚‚å¤§ä¸ˆå¤«ãªã‚“ã˜ã‚ƒãªã„ã®ï¼Ÿã¨ã¯æ€ã„ã¾ã™ãŒã€ã‚‚ã¨ã‚‚ã¨GitLabã¯å¥½å°è±¡ãªã‚µãƒ¼ãƒ“ã‚¹ã ã£ãŸã®ã§ã€ã„ã„æ©Ÿä¼šã ã‹ã‚‰ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¯GitLabã«ç§»è¡Œã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

GitHubã®æ™‚ã€CIã¯CircleCIã‚’ä½¿ã£ã¦ã„ãŸã®ã§ã™ãŒã€GitLabã«ã¯GitLab CIãªã‚‹ã‚‚ã®ãŒæ¨™æº–ã§ã‚ã‚‹ã‚ˆã†ãªã®ã§ã€ã›ã£ã‹ãã ã‹ã‚‰ã“ã¡ã‚‰ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ãŸã‚‰â€¦â€¦ã‚ã£ã¡ã‚ƒå¤§å¤‰ã ã£ãŸã®ã§ã€ã“ã“ã«2018å¹´6æœˆ7æ—¥æ™‚ç‚¹ã§ç„¡äº‹å‹•ã„ãŸå†…å®¹ã‚’æ›¸ã„ã¦ãŠãã¾ã™ğŸ˜­

ã¨ã‚Šã‚ãˆãšRails+Minitestãªç’°å¢ƒã§ã€ç°¡å˜ãªE2Eãƒ†ã‚¹ãƒˆã‚’å‹•ã‹ã—ã¦ã¿ãŸãƒªãƒã‚¸ãƒˆãƒªãŒã“ã¡ã‚‰ã€‚

[https://gitlab.com/t4traw/hello-gitlab-ci
![pipeline status](https://gitlab.com/t4traw/hello-gitlab-ci/badges/master/pipeline.svg)](https://gitlab.com/t4traw/hello-gitlab-ci)

æœ€çµ‚çš„ã«.gitlab-ci.ymlã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚

###### .gitlab-ci.yml

```yaml
image: ruby:2.5

services:
  - postgres:latest

variables:
  POSTGRES_DB: test_db
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: ""
  RUBYOPT: --encoding=UTF-8

stages:
  - test

before_script:
  - apt-get update -qy
  
  # Install nodejs
  - curl -sL https://deb.nodesource.com/setup_10.x | bash -
  - apt-get install -y nodejs

  - bundle install
  
  # Install yarn
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"
  - yarn install --ignore-engines
  
  # Install Chrome
  - apt-get install -y gdebi
  - curl -O https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - gdebi -n -q google-chrome-stable_current_amd64.deb
  
  # Set up database.yml
  - cp config/gitlab-database.yml config/database.yml
  
  # Create databse
  - RAILS_ENV=test bundle exec rails db:create db:schema:load

test:
  stage: test
  script:
  - bundle exec brakeman -4 -A -w 1 -z
  - bundle exec rails test
  - bundle exec rails test:system
```

ä»¥ä¸‹ã€å¤§å¤‰ã ã£ãŸã“ã¨ã‚’ã¤ã‚‰ã¤ã‚‰ã¨ã€‚

## nodejsã®æœ€æ–°ç‰ˆãŒapt-getã§è½ã¡ã¦ã“ãªã„

GitLabã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«`apt-get install -y nodejs`ã¨ã—ã‹æ›¸ã„ã¦ã„ãªã„ã®ã§ã€ãã®ã¨ãŠã‚Šã«ã—ãŸã‚‰apt-getã§è½ã¡ã¦ãã‚‹nodejsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ4.3ã¨ã„ã†å•é¡Œã€‚2018å¹´6æœˆ7æ—¥æ™‚ç‚¹ã§æœ€æ–°ã®nodejsã¯10.4ã€‚å…¨ç„¶é•ã†ã˜ã‚ƒãªã„ã¨ğŸ˜¢

å…·ä½“çš„ã«ã¯yarnå‘¨ã‚Šã§ã‚³ã‚±ã‚‹ã®ã§ã€`yarn install --ignore-engines`ã™ã‚Œã°å¤§ä¸ˆå¤«ï¼Ÿã¨æ€ã£ãŸã‘ã©ã€ã‚„ã£ã±ã‚Šãƒ€ãƒ¡ã ã£ãŸã€‚ã®ã§ã€å…¬å¼ã®`curl -sL https://deb.nodesource.com/setup_10.x | bash -`ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦æœ€æ–°ã®nodejsã‚’å…¥ã‚Œã¾ã—ãŸã€‚

## yarnãŒã†ã¾ãå‹•ã‹ãªã„

ã“ã‚Œã¯nodejsãŒãã‚‚ãã‚‚ã¾ã¨ã‚‚ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„çŠ¶æ…‹ã ã£ãŸã‹ã‚‰ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€yarnã‚‚apt-getã§ã¯ã†ã¾ãå‹•ãã¾ã›ã‚“ã§ã—ãŸğŸ’¦

ãªã®ã§ã€ã“ã¡ã‚‰ã‚‚å…¬å¼ã®`curl -o- -L https://yarnpkg.com/install.sh | bash`ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€æ›´ã«PATHã‚’é€šã™ã“ã¨ã§yarnãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## Headless chromeãŒå…¨ç„¶ã¾ã¨ã‚‚ã«å‹•ã‹ãªã„

ã“ã“ãŒä¸€ç•ªå¤§å¤‰ã ã£ãŸğŸ˜« ãã‚‚ãã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒ`dpkg -i google-chrome.deb`ã¨ã‹ã‚„ã£ã¦ã‚‚å…¨ç„¶ã†ã¾ãã„ã‹ãšã€gdebiã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹äº‹ã‚’åˆã‚ã¦çŸ¥ã‚Šç„¡äº‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‚‚ã®ã®ã€Selenium::WebDriver::Error::UnknownError: unknown error: DevToolsActivePort file doesn't existã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã€ä½•åº¦ã‚‚ã‚»ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚’æ›¸ãç›´ã—ã¦ãƒˆãƒ©ã‚¤ï¼†ã‚¨ãƒ©ãƒ¼ã‚’ç¹°ã‚Šè¿”ã—ã¾ã—ãŸã€‚

æ­£è§£ã‹ã©ã†ã‹ã¯ã¾ã ä¸å®‰ãªã®ã§ã™ãŒã€ã¨ã‚Šã‚ãˆãšè‡ªåˆ†ã®ç’°å¢ƒã§ã¯application_system_test_case.rbã«ã€ã“ã‚“ãªå…·åˆã«æ›¸ã‘ã°ã†ã¾ãã„ãã¾ã—ãŸã€‚

###### test/application_system_test_case.rb

```ruby
require "test_helper"

class ApplicationSystemTestCase < ActionDispatch::SystemTestCase
  capabilities = Selenium::WebDriver::Remote::Capabilities.chrome(
    chromeOptions: {
      args: %w(no-sandbox headless disable-gpu window-size=1280x800 disable-dev-shm-usage)
    }
  )

  driven_by :selenium, using: :chrome,
    options: { desired_capabilities: capabilities }
end
```

`no-sandbox`ã¨Dockerç’°å¢ƒãªã®ã§`disable-dev-shm-usage`ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¤§äº‹ãªã®ã¯åˆ†ã‹ã£ã¦ãŸã‚“ã ã‘ã©ã€èª¿ã¹ã‚‹å…ˆæ¯ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ›¸ãæ–¹ãŒãƒãƒ©ãƒãƒ©ã§ã€ã‹ãªã‚Šæ··ä¹±ã—ã¾ã—ãŸğŸ’«

## brakemanã§invalid byte sequence in US-ASCII While processingã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

æ‰‹å…ƒã§ã¯brakemanã®ãƒ†ã‚¹ãƒˆé€šã£ã¦ã„ã‚‹ã®ã«ã€CIã ã¨è½ã¡ã‚‹ã€‚ãˆãƒ¼ã€ã¨æ€ã£ã¦èª¿ã¹ã¦ã¿ãŸã‚‰ã€ã©ã†ã‚„ã‚‰Docker Hubã®Rubyã‚³ãƒ³ãƒ†ãƒŠã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ãŒUS-ASCIIã‚‰ã—ãã€`RUBYOPT=--encoding=UTF-8`ã¨ç’°å¢ƒå¤‰æ•°ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

## ãã—ã¦ã€ã‚ˆã†ã‚„ããƒ†ã‚¹ãƒˆãŒå…¨éƒ¨é€šã‚‹ğŸ˜­

æ¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚³ã‚±ã¦æœ¬å½“ã«å¤§å¤‰ã ã£ãŸorz ã‚“ã§ã‚‚ã¾ã‚ã“ã†ã„ã†çµŒé¨“ã§è©³ã—ããªã£ã¦ã„ãéƒ¨åˆ†ã¯ã‚ã‚Šã¾ã™ã‚ˆã­ã€‚

GitLabã§ã™ãŒã€ã‚‚ã¨ã‚‚ã¨é•å’Œæ„Ÿã‚ã£ãŸã€Œãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã¨ã„ã†è¨€è‘‰ãŒã€Œãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã ã£ãŸã‚Šã€ãƒ†ã‚¹ãƒˆè½ã¡ãŸã®ã‚’Issueä½œã‚ŒãŸã‚Šã€æ¨™æº–ã§IssueãŒç®¡ç†ã—ã‚„ã™ã‹ã£ãŸã‚Šã¨ã€ã“ã£ã¡ã®ã»ã†ãŒè‰¯ããªã„ï¼Ÿã¨æ€ã†éƒ¨åˆ†ãŒãŸãã•ã‚“ã‚ã‚Šã¾ã—ãŸã€‚

![](https://s3-ap-northeast-1.amazonaws.com/t4traw/2018-06-07_16-27-19.png)

ã—ã°ã‚‰ãGitLabã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
