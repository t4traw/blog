---
title: CentOS7にPostfix+Dovecot+Let's Enclypt環境をitamaeで構築する[1]
date: 2018-12-07
categories:
  - linux
tags:
  - centos
  - postfix
  - dovecot
  - itamae
  - letsencrypt
image: https://s3-ap-northeast-1.amazonaws.com/t4traw/ss/2018-12-06_10-53-23.png
draft: true
---
ひとまずFirewallの設定から。CentOS7からはファイアウォールがiptablesではなくfirewalldに変わったらしい。

<!--more-->

## CentOS7のfirewallのレシピ

サクっとfirewalldを停止してiptablesをインストール……といいたい所だけど、こういうのはデフォルトで採用されている物を使うべきという経験からfirewalldを使う事にした。

itamae-plugin-resource-firewalldというプラグインがあったが、はじめてだしそのままコマンドを直書きして設定する事にした。

```ruby
service 'firewalld' do
  action [:start, :enable]
end

# 自分用のsshポートを開ける
execute "add my-ssh port" do
  user "root"
  command "firewall-cmd --permanent --add-port=#{node.ssh.port}/tcp --zone=public"
end

# デフォルトのsshポートを閉じる
execute "remove default ssh port" do
  user "root"
  command "firewall-cmd --permanent --remove-service=ssh"
end

# webサーバー系のポートを開ける
execute "add web server ports" do
  user "root"
  cmd = [
    'firewall-cmd --permanent --add-service=http --zone=public',
    'firewall-cmd --permanent --add-service=https --zone=public'
  ]
  command cmd.join('&&')
end

# メールサーバー用のポートを開ける
execute "add mail server ports" do
  user "root"
  cmd = [
    'firewall-cmd --permanent --add-service=smtp --zone=public',
    'firewall-cmd --permanent --add-service=pop3s --zone=public',
    'firewall-cmd --permanent --add-service=imaps --zone=public',
    'firewall-cmd --permanent --add-service=imaps --zone=public'
  ]
  command cmd.join('&&')
end

service 'firewalld' do
  action [:restart]
end
```
